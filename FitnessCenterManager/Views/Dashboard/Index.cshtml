@model FitnessCenterManager.Models.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Panel";
}

<div class="container py-4">

    <h1 class="mb-3">Panel</h1>

    <div class="row mb-4">
        <!-- Salon Bilgileri -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 border-start border-4 border-success">
                <div class="card-body">
                    <h5 class="card-title text-success border-bottom pb-2">
                        <i class="bi bi-building"></i> Salon Bilgileri
                    </h5>

                    @if (Model.SporSalonu != null)
                    {
                        <div class="mt-3">
                            <p class="mb-2">
                                <i class="bi bi-shop text-muted"></i>
                                <strong>Salon Adi:</strong> @Model.SporSalonu.Ad
                            </p>
                            <p class="mb-2">
                                <i class="bi bi-geo-alt text-muted"></i>
                                <strong>Adres:</strong> @Model.SporSalonu.Adres
                            </p>
                            <p class="mb-2">
                                <i class="bi bi-telephone text-muted"></i>
                                <strong>Telefon:</strong> @Model.SporSalonu.Telefon
                            </p>
                          
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mt-3">Salon bilgisi bulunamadi.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Oturum Bilgileri -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 border-start border-4 border-primary">
                <div class="card-body">
                    <h5 class="card-title text-primary border-bottom pb-2">
                        <i class="bi bi-person-circle"></i> Oturum Bilgileri
                    </h5>

                    <div class="mt-3">
                        <p class="mb-2">
                            <i class="bi bi-person-badge text-muted"></i>
                            <strong>Kullanici Adi:</strong> @User.Identity?.Name
                        </p>

                        <p class="mb-2">
                            <i class="bi bi-envelope text-muted"></i>
                            <strong>E-Posta:</strong> @(Model.CurrentUserEmail ?? "Belirtilmemis")
                        </p>
                    </div>

                    <div class="mt-3">
                        <strong class="d-block mb-1">Yetkiler:</strong>
                        @if (Model.CurrentUserRoles.Any())
                        {
                            @foreach (var role in Model.CurrentUserRoles)
                            {
                                string badgeClass = role == "Admin" ? "bg-danger" : (role == "Uye" ? "bg-primary" : "bg-secondary");
                                <span class="badge @badgeClass me-1">@role</span>
                            }
                        }
                        else
                        {
                            <span class="badge bg-secondary">Yetki Yok</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (Model.IsAdmin)
    {
        <div class="mb-4">
            <h5 class="text-primary">
                <i class="bi bi-gear"></i> Yönetim Ýþlemleri (Admin)
            </h5>

            <div class="row g-2">
                <div class="col-md-4">
                    <a asp-controller="Salon" asp-action="Edit"
                       class="btn btn-secondary w-100 text-white">
                        <i class="bi bi-building"></i> Salon Bilgileri
                    </a>
                </div>

                <div class="col-md-4">
                    <a asp-controller="UzmanlikAlanlari" asp-action="Index"
                       class="btn btn-info w-100 text-white">
                        <i class="bi bi-award"></i> Uzmanlýk Alanlarý
                    </a>
                </div>

                <div class="col-md-4">
                    <a asp-controller="Hizmetler" asp-action="Index"
                       class="btn btn-success w-100 text-white">
                        <i class="bi bi-list-check"></i> Hizmetler
                    </a>
                </div>

                <div class="col-md-4">
                    <a asp-controller="AntrenorlerMvc" asp-action="Index"
                       class="btn btn-warning w-100 text-white">
                        <i class="bi bi-people"></i> Antrenörler
                    </a>
                </div>

                <div class="col-md-4">
                    <a asp-controller="RandevularMvc" asp-action="Index"
                       class="btn btn-danger w-100 text-white">
                        <i class="bi bi-calendar3"></i> Randevular
                    </a>
                </div>
            </div>
        </div>
    }

    <div class="mb-4">
        <h5 class="text-success"><i class="bi bi-calendar-check"></i> Randevu Islemleri</h5>
        <div class="row g-2">
            <div class="col-md-6">
                <a asp-controller="RandevularMvc"
                   asp-action="Create"
                   class="btn w-100 text-white"
                   style="background-color:#6f42c1;">
                    <i class="bi bi-calendar-plus"></i> Yeni Randevu Al
                </a>
            </div>

            @if (!Model.IsAdmin)
            {
                <div class="col-md-6">
                    <a asp-controller="RandevularMvc"
                       asp-action="Index"
                       class="btn w-100 text-white"
                       style="background-color:#e83e8c;">
                        <i class="bi bi-list-ul"></i> Randevularým
                    </a>
                </div>
            }


        </div>
    </div>

    <div class="card border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-search"></i> Antrenor Musaitlik Sorgulama</h5>
        </div>
        <div class="card-body">
            <p class="text-muted small">Randevu almak istediginiz gunu secin. Musait saatler <span class="badge bg-success">Yesil</span>, dolu saatler <span class="badge bg-danger">Kirmizi</span> gorunur.</p>

            <div class="input-group mb-3">
                <input type="date" id="appointmentDateInput" class="form-control"
                       min="@DateTime.Now.ToString("yyyy-MM-dd")"
                       aria-label="Randevu Tarihi Secin">
                <button id="checkAvailabilityBtn" class="btn btn-info text-white" type="button">
                    Uygun Saatleri Kontrol Et
                </button>
            </div>

            <div id="availableTrainersContainer"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const checkAvailabilityBtn = document.getElementById('checkAvailabilityBtn');
        const dateInput = document.getElementById('appointmentDateInput');
        const availableTrainersContainer = document.getElementById('availableTrainersContainer');

        if (checkAvailabilityBtn && dateInput) {
            checkAvailabilityBtn.addEventListener('click', function () {
                const selectedDate = dateInput.value;
                const button = this;

                if (!selectedDate) {
                    alert("Lutfen bir tarih secin!");
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Kontrol Ediliyor...';
                availableTrainersContainer.innerHTML = '';

                fetch(`/api/Antrenorler/availableSlots?date=${selectedDate}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Sunucu hatasi: ' + response.status);
                        return response.json();
                    })
                    .then(data => {
                        if (!Array.isArray(data) || data.length === 0) {
                            availableTrainersContainer.innerHTML = `
                                <div class="alert alert-warning mt-3">
                                    ${new Date(selectedDate).toLocaleDateString()} tarihinde uygun antrenor bulunamadi.
                                </div>`;
                            return;
                        }

                        let allTrainersHtml = '';

                        data.forEach(antrenor => {
                            let slotsHtml = '';

                            if (antrenor.slots && Array.isArray(antrenor.slots)) {
                                slotsHtml = antrenor.slots.map(slot => {
                                    const badgeClass = slot.isAvailable ? 'bg-success' : 'bg-danger text-white opacity-75';
                                    const icon = slot.isAvailable ? '(+) ' : '(-) ';
                                    const cursorStyle = slot.isAvailable ? 'cursor: pointer;' : 'cursor: not-allowed;';
                                    const title = slot.isAvailable ? 'Musait' : 'Dolu';

                                    return `<span class="badge ${badgeClass} p-2 m-1"
                                                  title="${title}"
                                                  style="font-size:0.9rem; ${cursorStyle}">
                                                ${icon}${slot.display}
                                            </span>`;
                                }).join('');
                            } else {
                                slotsHtml = '<span class="text-muted">Slot bilgisi yok.</span>';
                            }

                            allTrainersHtml += `
                                <div class="card mb-3 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0 text-dark">
                                            ${antrenor.antrenorAd} ${antrenor.antrenorSoyad}
                                        </h5>
                                        <small class="text-muted">Uzmanlik: ${antrenor.uzmanlikAlanlari || 'Genel'}</small>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text fw-bold text-secondary">Saat Durumlari:</p>
                                        <div class="d-flex flex-wrap">
                                            ${slotsHtml}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        availableTrainersContainer.innerHTML = allTrainersHtml;
                    })
                    .catch(err => {
                        console.error('Hata:', err);
                        availableTrainersContainer.innerHTML = `<div class="alert alert-danger mt-3">Hata: ${err.message}</div>`;
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.innerHTML = 'Uygun Saatleri Kontrol Et';
                    });
            });
        }
    </script>
}

